FROM nodesource/trusty:0.12
COPY ./package.json /lemur/package.json
WORKDIR /lemur
RUN npm install
COPY ./bower.json /lemur/bower.json
RUN npm run postinstall
COPY ./gulpfile.js ./gulp ./lemur /lemur/
RUN node_modules/.bin/gulp build && node_modules/.bin/gulp package
EXPORT /lemur/lemur/static/dist/ lemur_static_dist

FROM python:3-alpine
RUN apk add --update --no-cache \
             openssl \
             libpq postgresql-client \
             libffi
RUN adduser -D -h /lemur lemur
COPY setup.py README.rst lemur /lemur/
WORKDIR /lemur

ENV BUILD_DEPENDS "alpine-sdk openssl-dev postgresql-dev libffi-dev"
RUN echo $BUILD_DEPENDS | \
    xargs apk add --update --no-cache \
    && \
    pip install -e 'git+https://github.com/certbot/certbot#egg=acme-0.9.0.dev0&subdirectory=acme' &&\
    pip install -e . \
    && \
    echo $BUILD_DEPENDS | xargs apk del --purge
IMPORT lemur_static_dist/ /lemur/lemur/static/dist/

RUN chown -R lemur /lemur
USER lemur
RUN mkdir -p ~/.lemur && touch /lemur/lemur.log

USER root
#include https://github.com/progrium/entrykit
RUN wget -O- https://github.com/progrium/entrykit/releases/download/v0.4.0/entrykit_0.4.0_Linux_x86_64.tgz | tar -xzC /bin && \
    /bin/entrykit --symlink
RUN apk add --update --no-cache nginx sudo

COPY pkg/letsencrypt.crt /

COPY pkg/sites-enabled/ /etc/nginx/sites-enabled
COPY pkg/nginx.conf /etc/nginx/nginx.conf

COPY pkg/lemur.conf.py.tmpl /lemur/.lemur/lemur.conf.py.tmpl

WORKDIR /lemur/lemur/
ENTRYPOINT [ \
  "render", "/lemur/.lemur/lemur.conf.py", "--", \
  "switch", \
    "sh=/bin/sh", "--",  \
  "prehook", "sudo -Hu lemur lemur init", "--", \
  "codep", \
    "nginx", \
    "sudo -Hu lemur lemur start -w 6 -b 0.0.0.0:8000", \
    "tail -F /lemur/lemur.log /var/log/nginx/access.log /var/log/nginx/error.log" \
]

EXPOSE 80
#for use with e.g. https://github.com/gliderlabs/registrator
ENV SERVICE_80_NAME lemur
ENV SERVICE_80_CHECK_HTTP /healthz
#for use with e.g. https://github.com/ebay/fabio
ENV SERVICE_80_TAGS urlprefix-/lemur

TAG netflix/lemur

ONBUILD COPY lemur.conf.py /lemur/.lemur/lemur.conf.py.tmpl
ONBUILD COPY letsencrypt_account_key.pem /
